<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Barcode Scanner PWA – mit Zuständen</title>
  <link rel="manifest" href="manifest.json">
  <style>
    :root{
      --brand:#93c01f;
      --bg:#f9f9f9;
      --text:#333;
      --border:#ddd;
    }
    *{box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen;
      margin:0;
      padding:1rem;
      background-color:var(--bg);
      color:var(--text);
    }
    h1{color:var(--brand);margin-top:0}
    h2{margin:1.25rem 0 0.5rem 0}
    label{display:block;margin:0.25rem 0}
    button{
      background-color:var(--brand);
      color:#fff;
      border:none;
      padding:0.75rem 1.5rem;
      border-radius:10px;
      font-size:1rem;
      cursor:pointer;
      margin:1rem 0;
    }
    button.small{
      padding:0.25rem 0.75rem;
      border-radius:6px;
      margin:0;
      width:34px;height:34px;
    }
    input[type="text"]{
      width:100%;
      padding:0.75rem;
      font-size:1rem;
      border-radius:8px;
      border:1px solid #ccc;
      margin:0.5rem 0 1rem 0;
    }
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:1rem;
      background:#fff;
    }
    th,td{
      padding:0.5rem;
      border:1px solid var(--border);
      text-align:left;
      vertical-align:top;
    }
    th{
      background-color:var(--brand);
      color:#fff;
    }

    /* Per-Zustand-Steuerung */
    .state-controls{ display:flex; gap:.5rem; flex-wrap:wrap; align-items:center }
    .state-chip{ display:flex; align-items:center; gap:.25rem; border:1px solid var(--border); border-radius:8px; padding:.25rem; }
    .state-chip label{ font-size:.9rem; margin:0 .25rem 0 0; min-width:1.2rem; text-align:center; font-weight:600 }
    .state-chip input{ width:60px; text-align:center; padding:.25rem }
    .state-chip button.small{ width:28px; height:28px }

    /* Aktiver Scan-Zustand-Selector */
    .state-selector{ display:flex; gap:.5rem; align-items:center; flex-wrap:wrap }
    .state-selector .pill{ border:1px solid var(--border); background:#fff; color:var(--text); padding:.4rem .8rem; border-radius:999px; cursor:pointer }
    .state-selector .pill.active{ background:var(--brand); color:#fff; border-color:var(--brand) }

    /* Datei-Upload */
    .hidden-file{display:none}
    .file-button{
      display:inline-block;
      background-color:var(--brand);
      color:#fff;
      border:none;
      padding:0.75rem 1.5rem;
      border-radius:10px;
      font-size:1rem;
      cursor:pointer;
      margin:1rem 0;
      text-decoration:none;
      user-select:none;
    }
    #fileName{margin-left:0.5rem; font-size:0.95rem; opacity:0.8}

    /* Einstellungen */
    .settings{
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      padding:1rem;
      margin-top:0.5rem;
    }
    .toggle{ display:flex; align-items:center; gap:0.5rem; user-select:none }
    .inline-controls{ display:flex; align-items:center; gap:0.5rem; flex-wrap:wrap }
    .pallet-wrap{ display:flex; align-items:center; gap:0.5rem }
    #palletCount{ width:90px; text-align:center }
  </style>
</head>
<body>
  <h1>Barcode Scanner</h1>

  <label for="barcodeInput">Barcode-Eingabe (mit Handscanner):</label>
  <input type="text" id="barcodeInput" placeholder="Scanne hier den Barcode" autofocus autocomplete="off"/>

  <!-- Aktueller Zustands-Selector für den nächsten Scan -->
  <div class="state-selector" aria-label="Zustand für nächsten Scan wählen">
    <span>Scan-Zustand:</span>
    <button type="button" class="pill active" data-state="A">A-Ware</button>
    <button type="button" class="pill" data-state="B">B-Ware</button>
    <button type="button" class="pill" data-state="C">C-Ware</button>
  </div>

  <!-- CSV: Testgewichte hochladen -->
  <input type="file" id="csvFile" class="hidden-file" accept=".csv"/>
  <label for="csvFile" class="file-button">Testgewichte hochladen</label>
  <span id="fileName" aria-live="polite"></span>

  <!-- Einstellungen -->
  <div class="settings" aria-labelledby="settingsHeading">
    <h2 id="settingsHeading">Einstellungen</h2>

    <label class="toggle" for="ttsToggle">
      <input type="checkbox" id="ttsToggle"/>
      Sprachausgabe aktivieren
    </label>

    <div class="inline-controls" aria-labelledby="palletHeading">
      <label id="palletHeading">Palettenerfassung</label>
      <div class="pallet-wrap">
        <button type="button" id="palletMinus" class="small" aria-label="Palette minus">−</button>
        <input type="number" id="palletCount" class="qty-input" value="0" min="0" step="1" inputmode="numeric" aria-label="Anzahl Paletten"/>
        <button type="button" id="palletPlus" class="small" aria-label="Palette plus">+</button>
      </div>
      <small>(Tasten + / − verändern ebenfalls die Anzahl)</small>
    </div>
  </div>

  <!-- Aktionen -->
  <div class="actions" style="display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.75rem;">
    <button type="button" id="btnExportXls" title="Als Excel öffnen/speichern">Als XLS speichern</button>
    <button type="button" id="btnReset" title="Erfassung zurücksetzen">Zurücksetzen</button>
    <button type="button" id="btnFinalize" title="Vorgang abschließen">Abschließen</button>
  </div>

  <table id="resultTable" aria-live="polite">
    <thead>
      <tr>
        <th>Barcode</th>
        <th>Menge (Σ)</th>
        <th>Zustand (A/B/C)</th>
        <th>ItemTextName</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    // ===== Datenhaltung (mit Zustand A/B/C) =====
    // Struktur: scannedData[barcode] = { A: number, B: number, C: number }
    let scannedData = {};
    let barcodeMap = {};

    // Aktuell gewählter Zustand für den nächsten Scan
    let currentState = 'A';

    // ===== Audio: Bestätigungston (immer aktiv) =====
    let audioCtx = null;
    function beep(freq = 880, durationMs = 120, volume = 0.12, type = 'sine'){
      try{
        audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
        if(audioCtx.state === 'suspended'){ audioCtx.resume(); }
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(volume, audioCtx.currentTime);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + durationMs/1000);
      }catch(e){ console.warn('Beep konnte nicht abgespielt werden:', e); }
    }

    // ===== Sprachausgabe (standardmäßig AUS) =====
    const ttsToggle = document.getElementById('ttsToggle');
    function speak(text){
      if(!ttsToggle.checked) return; // nur wenn aktiviert
      if('speechSynthesis' in window){
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'de-DE';
        window.speechSynthesis.speak(u);
      }
    }

    // ===== Zustands-Selector (A/B/C) =====
    const selector = document.querySelector('.state-selector');
    selector.addEventListener('click', (e)=>{
      const btn = e.target.closest('.pill');
      if(!btn) return;
      currentState = btn.getAttribute('data-state');
      selector.querySelectorAll('.pill').forEach(p=>p.classList.toggle('active', p===btn));
      speak(currentState + '-Ware gewählt');
    });

    // ===== CSV-Upload mit Auto-Delimiter & sicherem Parser =====
    const csvFile = document.getElementById('csvFile');
    const fileNameSpan = document.getElementById('fileName');

    function normalizeHeader(h){
      return h.replace(/^\uFEFF/, '').replace(/^"+|"+$/g,'').trim().toLowerCase();
    }
    function splitRespectingQuotes(line, delim){
      const out = []; let cur = ''; let inQuotes = false;
      for(let i=0;i<line.length;i++){
        const ch = line[i];
        if(ch === '"'){
          if(inQuotes && line[i+1] === '"'){ cur += '"'; i++; }
          else { inQuotes = !inQuotes; }
        }else if(ch === delim && !inQuotes){ out.push(cur); cur = ''; }
        else{ cur += ch; }
      }
      out.push(cur); return out;
    }
    function countDelim(line, delim){
      let inQuotes=false, c=0;
      for(let i=0;i<line.length;i++){
        const ch=line[i];
        if(ch==='"'){ if(inQuotes && line[i+1]==='"'){ i++; } else { inQuotes=!inQuotes; } }
        else if(ch===delim && !inQuotes){ c++; }
      }
      return c;
    }
    function detectDelimiter(firstLine){
      const candidates = [';', ',', '\t'];
      let best=';', bestCount=-1;
      for(const cand of candidates){
        const count = countDelim(firstLine, cand==='\t'?'\t':cand);
        if(count>bestCount){ bestCount=count; best=cand; }
      }
      return best==='\t'?'\t':best;
    }

    csvFile.addEventListener('change', handleCSV);
    function handleCSV(event){
      const file = event.target.files[0];
      if(!file) return;
      fileNameSpan.textContent = file.name;
      const reader = new FileReader();
      reader.onload = function(e){
        const raw = e.target.result;
        const text = raw.replace(/\r/g,'');
        const lines = text.split('\n').filter(r => r.trim().length>0);
        if(lines.length === 0){ alert('Die CSV ist leer.'); return; }
        const delim = detectDelimiter(lines[0]);
        const headerRaw = splitRespectingQuotes(lines[0], delim);
        const headers = headerRaw.map(normalizeHeader);
        const wantBarcode = 'variationbarcode.code';
        const wantName = 'itemtextname';
        const barcodeIndex = headers.indexOf(wantBarcode);
        const nameIndex = headers.indexOf(wantName);
        if(barcodeIndex === -1 || nameIndex === -1){
          alert(
            'CSV-Problem:\n'
            + 'Erwartete Spalten: "VariationBarcode.code" und "ItemTextName".\n'
            + 'Erkannter Trenner: ' + (delim === '\t' ? 'TAB' : delim) + '\n'
            + 'Gefundene Kopfzeilen: ' + headerRaw.join(', ')
          );
          return;
        }
        barcodeMap = {};
        for(let i=1;i<lines.length;i++){
          const cols = splitRespectingQuotes(lines[i], delim);
          if(cols.length > Math.max(barcodeIndex, nameIndex)){
            const code = (cols[barcodeIndex]||'').replace(/^"+|"+$/g,'').trim();
            const name = (cols[nameIndex]||'').replace(/^"+|"+$/g,'').trim();
            if(code){ barcodeMap[code] = name || ''; }
          }
        }
        updateTable();
        speak('Testgewichte geladen.');
      };
      reader.readAsText(file);
    }

    // ===== Barcode-Eingabe (Enter) – bucht in den gewählten Zustand =====
    document.getElementById('barcodeInput').addEventListener('keydown', function(event){
      if(event.key === 'Enter'){
        const barcode = event.target.value.trim();
        if(barcode){
          if(!scannedData[barcode]) scannedData[barcode] = {A:0,B:0,C:0};
          scannedData[barcode][currentState]++;
          updateTable();
          beep();
          const name = barcodeMap[barcode] ? (barcodeMap[barcode] + ', ') : '';
          const total = totalFor(scannedData[barcode]);
          speak(name + currentState + '-Ware, Gesamt ' + total);
          event.target.value = '';
        }
      }
    });

    // ===== Helpers =====
    function totalFor(entry){ return (entry?.A||0) + (entry?.B||0) + (entry?.C||0); }
    function objectEntriesSorted(obj){ return Object.entries(obj).sort((a,b)=> a[0].localeCompare(b[0], 'de')); }

    // ===== Tabelle aktualisieren =====
    function updateTable(){
      const tbody = document.querySelector('#resultTable tbody');
      tbody.innerHTML = '';
      for(const [barcode, entry] of objectEntriesSorted(scannedData)){
        const row = document.createElement('tr');

        const tdBarcode = document.createElement('td');
        tdBarcode.textContent = barcode;

        const tdTotal = document.createElement('td');
        tdTotal.textContent = String(totalFor(entry));

        const tdState = document.createElement('td');
        tdState.appendChild(renderStateControls(barcode, entry));

        const tdName = document.createElement('td');
        tdName.textContent = barcodeMap[barcode] || '-';

        row.appendChild(tdBarcode);
        row.appendChild(tdTotal);
        row.appendChild(tdState);
        row.appendChild(tdName);
        tbody.appendChild(row);
      }
    }

    function renderStateControls(barcode, entry){
      const wrap = document.createElement('div');
      wrap.className = 'state-controls';
      ['A','B','C'].forEach(state=>{
        const chip = document.createElement('div');
        chip.className = 'state-chip';
        const lbl = document.createElement('label');
        lbl.textContent = state;
        const minus = document.createElement('button');
        minus.type='button'; minus.className='small'; minus.textContent='−';
        const inp = document.createElement('input');
        inp.type='number'; inp.min=0; inp.step=1; inp.value = entry[state]||0;
        inp.setAttribute('aria-label', `Anzahl ${state}-Ware`);
        const plus = document.createElement('button');
        plus.type='button'; plus.className='small'; plus.textContent='+';

        minus.onclick = ()=>{ if(scannedData[barcode][state]>0){ scannedData[barcode][state]--; updateTable(); } };
        plus.onclick = ()=>{ scannedData[barcode][state]++; updateTable(); };
        inp.addEventListener('change', ()=>{
          let v = parseInt(inp.value,10);
          if(isNaN(v) || v<0){ v = entry[state]||0; }
          scannedData[barcode][state] = v; updateTable();
        });

        chip.appendChild(lbl);
        chip.appendChild(minus);
        chip.appendChild(inp);
        chip.appendChild(plus);
        wrap.appendChild(chip);
      });
      return wrap;
    }

    // ===== Palettenerfassung =====
    let palletCount = 0;
    const palletInput = document.getElementById('palletCount');
    const palletPlus = document.getElementById('palletPlus');
    const palletMinus = document.getElementById('palletMinus');
    function syncPallet(){ palletInput.value = palletCount; }
    function incPallet(){ palletCount++; syncPallet(); speak('Paletten: ' + palletCount); }
    function decPallet(){ if(palletCount>0){ palletCount--; syncPallet(); speak('Paletten: ' + palletCount); } }
    palletPlus.addEventListener('click', incPallet);
    palletMinus.addEventListener('click', decPallet);
    palletInput.addEventListener('change', () => { const v = parseInt(palletInput.value, 10); palletCount = isNaN(v)||v<0 ? 0 : v; syncPallet(); });
    document.addEventListener('keydown', (e) => {
      const ae = document.activeElement;
      const isInput = ae && (ae.tagName === 'INPUT' || ae.tagName === 'TEXTAREA' || ae.isContentEditable);
      if(isInput && ae !== document.body) return;
      if(e.key === '+' || e.key === 'Add'){ incPallet(); }
      if(e.key === '-' || e.key === 'Subtract'){ decPallet(); }
    });

    // ===== Export, Reset, Finalize =====
    function exportXls(){
      const rows = objectEntriesSorted(scannedData);
      const timestamp = new Date().toISOString().replace(/[:T]/g,'-').slice(0,19);
      let tableHtml = '<table border="1"><thead><tr>'+
        '<th>Barcode</th><th>Menge (Σ)</th><th>A</th><th>B</th><th>C</th><th>ItemTextName</th>'+
        '</tr></thead><tbody>';
      for(const [barcode,entry] of rows){
        const name = (barcodeMap[barcode] || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const total = totalFor(entry);
        tableHtml += `<tr><td>${barcode}</td><td>${total}</td><td>${entry.A||0}</td><td>${entry.B||0}</td><td>${entry.C||0}</td><td>${name}</td></tr>`;
      }
      tableHtml += '</tbody></table>';
      const summary = '<p><strong>Paletten:</strong> ' + (typeof palletCount !== 'undefined' ? palletCount : 0) + '</p>';
      const htmlDoc = '<html><head><meta charset="utf-8"></head><body>'
        + '<h3>Barcode-Erfassung</h3>'
        + '<p><strong>Exportzeit:</strong> ' + new Date().toLocaleString() + '</p>'
        + summary + tableHtml + '</body></html>';
      const blob = new Blob(['\ufeff' + htmlDoc], {type: 'application/vnd.ms-excel'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'barcode_export_' + timestamp + '.xls';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function resetAll(){
      if(!confirm('Wirklich alles zurücksetzen?\nMengen, Tabelle und Palettenerfassung werden geleert.')) return;
      scannedData = {};
      palletCount = 0;
      syncPallet();
      updateTable();
      beep(440, 80);
    }

    function finalize(){
      const doExport = confirm('Vorgang abschließen?\nMöchten Sie die Erfassung vorher als XLS speichern?\nOK = Speichern & Abschließen, Abbrechen = nur Abschließen');
      if(doExport){ exportXls(); }
      scannedData = {};
      updateTable();
      beep(660, 150);
      alert('Erfassung abgeschlossen.');
    }

    document.getElementById('btnExportXls').addEventListener('click', exportXls);
    document.getElementById('btnReset').addEventListener('click', resetAll);
    document.getElementById('btnFinalize').addEventListener('click', finalize);
  </script>
</body>
</html>
