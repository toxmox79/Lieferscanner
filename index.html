<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Barcode Scanner PWA</title>
  <link rel="manifest" href="manifest.json">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen;
      margin: 0;
      padding: 1rem;
      background-color: #f9f9f9;
      color: #333;
    }
    h1 {
      color: #93c01f;
    }
    button, input[type="file"] {
      background-color: #93c01f;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 10px;
      font-size: 1rem;
      cursor: pointer;
      margin: 1rem 0.5rem 1rem 0;
    }
    input[type="text"] {
      width: 100%;
      padding: 0.75rem;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin: 0.5rem 0 1rem 0;
    }
    label.toggle {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
      gap: 0.5rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      padding: 0.5rem;
      border: 1px solid #ddd;
      text-align: left;
    }
    th {
      background-color: #93c01f;
      color: white;
    }
    .qty-controls {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    .qty-controls button {
      background-color: #93c01f;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 1rem;
      width: 30px;
      height: 30px;
      cursor: pointer;
    }
    input.qty-input {
      width: 60px;
      padding: 0.25rem;
      font-size: 1rem;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Barcode Scanner</h1>
  <label for="barcodeInput">Barcode-Eingabe (mit Handscanner):</label>
  <input type="text" id="barcodeInput" placeholder="Scanne hier den Barcode" autofocus />

  <label class="toggle">
    <input type="checkbox" id="speechToggle" checked />
    Sprachausgabe aktivieren
  </label>

  <input type="file" accept=".csv" onchange="handleCSV(event)" />
  <button onclick="exportToExcel()">Scan abschließen & XLS speichern</button>
  <button onclick="resetScan()">Zurücksetzen</button>

  <table id="resultTable">
    <thead>
      <tr>
        <th>Barcode</th>
        <th>Menge</th>
        <th>ItemTextName</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <audio id="beepSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

  <script>
    let scannedData = {};
    let barcodeMap = {};

    const barcodeInput = document.getElementById("barcodeInput");
    const beepSound = document.getElementById("beepSound");
    const speechToggle = document.getElementById("speechToggle");

    barcodeInput.addEventListener("keydown", function(event) {
      if (event.key === "Enter") {
        const barcode = event.target.value.trim();
        if (barcode) {
          if (!scannedData[barcode]) scannedData[barcode] = 0;
          scannedData[barcode]++;
          updateTable();

          // Beep abspielen
          beepSound.currentTime = 0;
          beepSound.play();

          // Modellbezeichnung vorlesen (wenn aktiviert)
          const name = barcodeMap[barcode];
          if (speechToggle.checked && name) {
            const utterance = new SpeechSynthesisUtterance(name);
            utterance.lang = 'de-DE';
            speechSynthesis.speak(utterance);
          }

          event.target.value = "";
        }
      }
    });

    function handleCSV(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        const rows = text.split("\n");
        const headers = rows[0].split(";");

        const barcodeIndex = headers.indexOf("VariationBarcode.code");
        const nameIndex = headers.indexOf("ItemTextName");

        for (let i = 1; i < rows.length; i++) {
          const cols = rows[i].split(";");
          if (cols.length > Math.max(barcodeIndex, nameIndex)) {
            barcodeMap[cols[barcodeIndex].trim()] = cols[nameIndex]?.trim();
          }
        }
        updateTable();
      };
      reader.readAsText(file);
    }

    function updateTable() {
      const tbody = document.querySelector("#resultTable tbody");
      tbody.innerHTML = "";

      for (const [barcode, count] of Object.entries(scannedData)) {
        const row = document.createElement("tr");

        const tdBarcode = document.createElement("td");
        tdBarcode.textContent = barcode;

        const tdCount = document.createElement("td");
        const controls = document.createElement("div");
        controls.className = "qty-controls";

        const btnMinus = document.createElement("button");
        btnMinus.textContent = "-";
        btnMinus.onclick = () => {
          if (scannedData[barcode] > 0) {
            scannedData[barcode]--;
            updateTable();
          }
        };

        const input = document.createElement("input");
        input.type = "number";
        input.className = "qty-input";
        input.value = count;
        input.addEventListener("change", function() {
          const newVal = parseInt(this.value);
          if (!isNaN(newVal) && newVal >= 0) {
            scannedData[barcode] = newVal;
            updateTable();
          }
        });

        const btnPlus = document.createElement("button");
        btnPlus.textContent = "+";
        btnPlus.onclick = () => {
          scannedData[barcode]++;
          updateTable();
        };

        controls.appendChild(btnMinus);
        controls.appendChild(input);
        controls.appendChild(btnPlus);
        tdCount.appendChild(controls);

        const tdName = document.createElement("td");
        tdName.textContent = barcodeMap[barcode] || "-";

        row.appendChild(tdBarcode);
        row.appendChild(tdCount);
        row.appendChild(tdName);
        tbody.appendChild(row);
      }
    }

    function exportToExcel() {
      const data = Object.entries(scannedData).map(([barcode, qty]) => ({
        Barcode: barcode,
        Menge: qty,
        ItemTextName: barcodeMap[barcode] || "-"
      }));
      const worksheet = XLSX.utils.json_to_sheet(data);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Scans");
      XLSX.writeFile(workbook, "barcode_scans.xlsx");
    }

    function resetScan() {
      if (confirm("Möchtest du wirklich alle Scans zurücksetzen?")) {
        scannedData = {};
        updateTable();
      }
    }
  </script>
</body>
</html>
